{% extends 'base.html' %}
{% block content %}
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Strategies</h5>
        <p class="display-6">{{ summary|length }}</p>
        <p class="text-muted">Strategies with recorded performance.</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Trades</h5>
        <p class="display-6">{{ trades_count }}</p>
        <p class="text-muted">Total executed trades in reports.</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Active Alerts</h5>
        <p class="display-6">{{ alerts_count }}</p>
        <p class="text-muted">Signals generated for the latest trading session.</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Equity Curve</h5>
        {% if equity_chart %}
          <div id="equity-chart" role="img" aria-label="Equity curve chart"></div>
        {% else %}
          <div class="alert alert-info" role="status">No trades recorded yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Strategy Performance</h5>
        {% if strategy_chart %}
          <div id="strategy-chart" role="img" aria-label="Strategy net profit chart"></div>
        {% else %}
          <div class="alert alert-info" role="status">Run the pipeline to see strategy results.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Strategy Summary</h5>
    {% if summary %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Strategy</th>
              <th scope="col">Trades</th>
              <th scope="col">Win Rate</th>
              <th scope="col">Net PnL</th>
              <th scope="col">Average Return %</th>
              <th scope="col">Total Return %</th>
              <th scope="col">Exposure Days</th>
            </tr>
          </thead>
          <tbody>
            {% for row in summary %}
            <tr>
              <th scope="row">{{ row.Strategy }}</th>
              <td>{{ row.Trades }}</td>
              <td>{{ (row.WinRate * 100)|round(2) }}%</td>
              <td>{{ row.NetPnL|round(2) }}</td>
              <td>{{ (row.AverageReturnPct * 100)|round(2) }}%</td>
              <td>{{ (row.TotalReturnPct * 100)|round(2) }}%</td>
              <td>{{ row.ExposureDays }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-warning" role="status">No strategy results available. Run the daily pipeline to populate this view.</div>
    {% endif %}
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Latest Alerts</h5>
    {% if alerts %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Ticker</th>
              <th scope="col">Strategy</th>
              <th scope="col">Signal Date</th>
              <th scope="col">Action</th>
              <th scope="col">Price</th>
              <th scope="col">Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for alert in alerts %}
            <tr>
              <th scope="row"><a href="/trades/{{ alert.ticker }}" class="text-decoration-none">{{ alert.ticker }}</a></th>
              <td>{{ alert.strategy }}</td>
              <td>{{ alert.signal_date }}</td>
              <td><span class="badge bg-success">{{ alert.action }}</span></td>
              <td>{{ alert.price|round(2) }}</td>
              <td>{{ alert.notes or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-secondary" role="status">No alerts stored in the database yet.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if equity_chart or strategy_chart %}
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js" integrity="sha384-uJz8Y2pH6h1JkU1C0Hc7F9ptDDj1fJx/NONVqHHYoxGsG8ZMqCO8IHgp73J3C2zY" crossorigin="anonymous"></script>
  {% endif %}
  {% if equity_chart %}
    <script>Plotly.newPlot('equity-chart', {{ equity_chart|safe }});</script>
  {% endif %}
  {% if strategy_chart %}
    <script>Plotly.newPlot('strategy-chart', {{ strategy_chart|safe }});</script>
  {% endif %}
{% endblock %}
